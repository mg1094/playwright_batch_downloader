# 文档校验功能说明

## 概述

新增的文档校验功能使用OpenAI多模态大语言模型对下载的政务材料文档进行智能校验，确保文档质量和规范性。

## 校验项目

系统会对每个材料的"空白表格"和"示例样表"进行以下6项校验：

### 1. 两表格内容样式是否一致
- **目的**: 确认空白表格和示例样表是同一个模板的不同状态
- **校验内容**: 表格结构、布局、字段标签、样式等应完全一致
- **合理差异**: 仅示例样表中填写了示例数据

### 2. 材料名称和空白表格主旨是否相符
- **目的**: 验证空白表格与材料名称的匹配性
- **校验内容**: 文档标题、主要内容是否与Excel中的材料名称语义相符

### 3. 材料名称和示例样表主旨是否相符
- **目的**: 验证示例样表与材料名称的匹配性
- **校验内容**: 文档标题、主要内容是否与Excel中的材料名称语义相符

### 4. 空白表格无示例
- **目的**: 确认空白表格是纯净的待填写状态
- **校验内容**: 不应包含具体的个人示例信息（允许提示性文字）

### 5. 示例样表包含填写示例
- **目的**: 确认示例样表提供了有效的填写参考
- **校验内容**: 必须包含已填写的示例内容

### 6. 示例样表信息是否打码
- **目的**: 确认个人信息已正确脱敏
- **校验内容**: 姓名、电话、地址等敏感信息应为"张xx"、"139xxxx"等打码格式

## 技术实现

### 核心技术栈
- **多模态AI**: OpenAI GPT-4V (Vision) 模型
- **文档处理**: PyMuPDF + Pillow
- **格式支持**: PDF、DOC、DOCX

### 处理流程
1. **文档转换**: 将下载的文档转换为高清图片
2. **视觉分析**: 使用多模态AI分析文档图片内容
3. **智能判断**: 基于精心设计的提示词进行校验
4. **结果输出**: 将校验结果写入Excel文件

## 使用方法

### 基础用法（不启用校验）
```bash
python examples/batch_runner.py sample_test_data.xlsx
```

### 启用文档校验
```bash
# 通过命令行参数
python examples/batch_runner.py sample_test_data.xlsx --openai-key YOUR_API_KEY

# 通过环境变量
export OPENAI_API_KEY="YOUR_API_KEY"
python examples/batch_runner.py sample_test_data.xlsx

# 使用自定义API端点（如代理服务）
python examples/batch_runner.py sample_test_data.xlsx --openai-key YOUR_API_KEY --openai-base-url https://your-proxy.com/v1
```

### 输出文件格式

启用校验后，输出的Excel文件将包含以下列：

| 基础列 | 校验列 |
|--------|--------|
| • url<br>• 材料名称<br>• 元素名称<br>• 执行时间<br>• 执行结果<br>• 文件格式 | • 两表格内容样式是否一致<br>• 材料名称和空白表格主旨是否相符<br>• 材料名称和示例样表主旨是否相符<br>• 空白表格无示例<br>• 示例样表包含填写示例<br>• 示例样表信息是否打码 |

### 校验结果格式

- **通过**: `通过: 详细原因`
- **未通过**: `未通过: 详细原因`
- **未校验**: 文件未下载成功或校验功能未启用
- **校验出错**: `校验出错: 错误信息`

## 配置要求

### OpenAI API配置
- **API密钥**: 需要有效的OpenAI API密钥
- **模型权限**: 确保有GPT-4V (gpt-4o) 模型的访问权限
- **费用预算**: 多模态API调用费用较高，请合理控制使用

### 系统依赖（可选）
为获得最佳的文档转换效果，建议安装LibreOffice：

```bash
# macOS
brew install --cask libreoffice

# Ubuntu/Debian  
sudo apt-get install libreoffice

# Windows
# 从官网下载安装: https://www.libreoffice.org/
```

## 注意事项

### 成本控制
- 每次校验会调用OpenAI API，产生费用
- 建议先在小规模数据上测试
- 可以通过`--openai-base-url`使用更经济的第三方API服务

### 准确性说明
- AI校验结果仅供参考，重要场景建议人工复核
- 对于特殊格式或复杂文档，可能存在识别偏差
- 系统会提供详细的判断理由，便于人工审核

### 故障排除

**LibreOffice不可用**：
- 系统会自动使用备用方案（基于文本的简化预览）
- 建议安装LibreOffice以获得最佳效果

**API调用失败**：
- 检查网络连接和API密钥有效性
- 查看错误信息，可能需要配置代理

**文档转换失败**：
- 检查文档格式是否受支持
- 确认文档文件完整无损

## 扩展开发

### 自定义校验规则
可以在`document_validator.py`中修改提示词（Prompt）来调整校验标准：

```python
# 在 _validate_both_documents 方法中
messages = [
    {
        "role": "user", 
        "content": [
            {
                "type": "text",
                "text": "您的自定义校验提示词..."
            }
            # ...
        ]
    }
]
```

### 添加新的校验项目
1. 在`ValidationResult`类中添加新字段
2. 在相应的校验方法中更新提示词
3. 在`_update_validation_results`中处理新结果
4. 在`run_batch_tests`中添加新的输出列

## 技术支持

如遇到问题，请检查：
1. 依赖包安装是否完整
2. OpenAI API配置是否正确
3. 网络连接是否正常
4. 输入文档格式是否支持

更多技术细节请参考源码中的注释和文档字符串。
